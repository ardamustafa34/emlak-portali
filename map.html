<!DOCTYPE html>
<html class="light" lang="tr">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Parsel Sorgu | Global Emlak Portalı</title>

    <!-- Auth Guard -->
    <script>
        if (localStorage.getItem('isLoggedIn') !== 'true') {
            window.location.href = 'login.html';
        }
    </script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#1e3a1e",
                        "brand-gold": "#C5A059",
                        "brand-green": "#2D5A27",
                        "accent": "#4CAF50",
                    },
                    fontFamily: {
                        "sans": ["Inter", "sans-serif"]
                    }
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
        }

        #map {
            height: 100vh;
            width: 100%;
            z-index: 0;
            background: #0f172a;
        }

        /* Glassmorphism Sidebar */
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .dark .glass-panel {
            background: rgba(15, 23, 42, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .user-panel {
            background: rgba(30, 58, 30, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 5px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        /* Leaflet Controls Styling */
        .leaflet-bar {
            border: none !important;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3) !important;
        }

        .leaflet-bar a {
            background-color: rgba(255, 255, 255, 0.9) !important;
            color: #1e293b !important;
            backdrop-filter: blur(5px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05) !important;
        }

        /* Animations */
        @keyframes slideIn {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeInDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .animate-slide {
            animation: slideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .animate-fade-down {
            animation: fadeInDown 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Leaflet Popup Styling */
        .leaflet-popup-content-wrapper {
            background: rgba(255, 255, 255, 0.9) !important;
            backdrop-filter: blur(12px);
            border-radius: 15px !important;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2) !important;
        }

        .leaflet-popup-tip {
            background: rgba(255, 255, 255, 0.9) !important;
        }
    </style>
    <script>
        // Auth Guard
        if (localStorage.getItem('isLoggedIn') !== 'true') {
            window.location.href = 'login.html';
        }
    </script>
</head>

<body class="text-slate-900 dark:text-slate-100 overflow-hidden relative">

    <!-- Top Navigation / User Profile -->
    <nav
        class="user-panel absolute top-4 right-4 z-[1000] px-4 py-2 rounded-2xl shadow-2xl flex items-center gap-4 animate-fade-down">
        <div class="flex items-center gap-3 pr-4 border-r border-white/10">
            <div
                class="size-10 bg-brand-gold/20 rounded-xl flex items-center justify-center border border-brand-gold/30">
                <span class="material-symbols-outlined text-brand-gold text-2xl">person</span>
            </div>
            <div class="hidden sm:block">
                <p id="welcomeText" class="text-xs font-bold text-white/60 uppercase tracking-widest text-right">Hoş
                    Geldiniz</p>
                <p id="userName" class="text-sm font-extrabold text-white tracking-tight text-right">Kullanıcı</p>
            </div>
        </div>
        <button onclick="logout()"
            class="group flex items-center justify-center p-2 rounded-xl bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white transition-all duration-300">
            <span class="material-symbols-outlined text-2xl">logout</span>
        </button>
    </nav>

    <!-- Sidebar / Sorgu Paneli -->
    <aside id="sidebar"
        class="glass-panel absolute top-4 left-4 z-[1000] w-[calc(100%-2rem)] md:w-96 max-h-[calc(100vh-2rem)] rounded-2xl shadow-2xl flex flex-col overflow-hidden transition-all duration-500 transform animate-slide">

        <!-- Header -->
        <div class="px-6 py-5 bg-gradient-to-r from-primary to-brand-green text-white relative">
            <div class="flex items-center gap-3">
                <div class="bg-white/10 p-2 rounded-lg backdrop-blur-md">
                    <span class="material-symbols-outlined text-2xl text-brand-gold">explore</span>
                </div>
                <div>
                    <h1 class="text-lg font-extrabold tracking-tight">Parsel Sorgu Sistemi</h1>
                    <p class="text-[10px] text-white/70 uppercase tracking-widest font-semibold mt-0.5">TKGM Kurumsal
                        Veri Hattı</p>
                </div>
            </div>
            <button onclick="toggleSidebar()"
                class="absolute top-5 right-5 text-white/60 hover:text-white transition-colors">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>

        <!-- Scrollable content -->
        <div class="p-6 flex flex-col gap-5 overflow-y-auto">

            <section class="space-y-4">
                <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Konum Bilgileri</h2>

                <!-- İl Seçimi -->
                <div class="space-y-1.5">
                    <label class="text-xs font-semibold px-1">İl</label>
                    <select id="citySelect"
                        class="w-full h-11 px-4 rounded-xl border-slate-200 bg-white text-sm focus:border-brand-green focus:ring-brand-green dark:bg-slate-800 dark:border-slate-700 transition-all outline-none">
                        <option value="İstanbul">İstanbul</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <!-- İlçe Seçimi -->
                    <div class="space-y-1.5">
                        <label class="text-xs font-semibold px-1">İlçe</label>
                        <select id="districtSelect"
                            class="w-full h-11 px-4 rounded-xl border-slate-200 bg-white text-sm focus:border-brand-green focus:ring-brand-green dark:bg-slate-800 dark:border-slate-700 outline-none">
                            <option value="">Seçiniz</option>
                        </select>
                    </div>

                    <!-- Mahalle Seçimi -->
                    <div class="space-y-1.5">
                        <label class="text-xs font-semibold px-1">Mahalle</label>
                        <select id="neighborhoodSelect"
                            class="w-full h-11 px-4 rounded-xl border-slate-200 bg-white text-sm focus:border-brand-green focus:ring-brand-green dark:bg-slate-800 dark:border-slate-700 outline-none">
                            <option value="">Seçiniz</option>
                        </select>
                    </div>
                </div>
            </section>

            <section class="space-y-4">
                <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Ada & Parsel</h2>
                <div class="grid grid-cols-2 gap-3">
                    <!-- Ada -->
                    <div class="space-y-1.5">
                        <label class="text-xs font-semibold px-1">Ada No</label>
                        <input type="text" id="blockInput" placeholder="191"
                            class="w-full h-11 px-4 rounded-xl border-slate-200 bg-white text-sm focus:border-brand-green focus:ring-brand-green dark:bg-slate-800 dark:border-slate-700 outline-none" />
                    </div>
                    <!-- Parsel -->
                    <div class="space-y-1.5">
                        <label class="text-xs font-semibold px-1">Parsel No</label>
                        <input type="text" id="parcelInput" placeholder="24"
                            class="w-full h-11 px-4 rounded-xl border-slate-200 bg-white text-sm focus:border-brand-green focus:ring-brand-green dark:bg-slate-800 dark:border-slate-700 outline-none" />
                    </div>
                </div>
            </section>

            <button onclick="sorgula()"
                class="w-full h-14 bg-brand-green hover:bg-primary text-white font-bold rounded-2xl shadow-xl shadow-brand-green/20 flex items-center justify-center gap-3 active:scale-[0.98] transition-all group">
                <span class="material-symbols-outlined group-hover:rotate-12 transition-transform">search</span>
                Sorgulamayı Başlat
            </button>

            <!-- Loading Indicator -->
            <div id="loading" class="hidden py-4 text-center">
                <div
                    class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-white/20 border-t-brand-green">
                </div>
                <p class="text-xs font-medium text-slate-500 mt-2">Sunucudan veriler çekiliyor...</p>
            </div>

            <!-- Sonuç Bilgi Kartı -->
            <div id="resultCard"
                class="hidden animate-slide bg-white dark:bg-slate-800 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm overflow-hidden">
                <div
                    class="bg-brand-green/5 dark:bg-brand-green/10 px-4 py-3 border-b border-slate-100 dark:border-slate-700 flex items-center justify-between">
                    <span class="text-sm font-bold text-brand-green">Eşleşme Bulundu</span>
                    <span class="material-symbols-outlined text-brand-green">task_alt</span>
                </div>
                <div class="p-4 space-y-3">
                    <div class="flex flex-col">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">Lokasyon
                            Detayı</span>
                        <span id="resLocation"
                            class="text-sm font-semibold truncate italic text-slate-700 dark:text-slate-200">İstanbul /
                            Silivri</span>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">Kayıtlı
                            Ada/Parsel</span>
                        <span id="resBlockParcel" class="text-lg font-extrabold text-primary dark:text-brand-gold">191 /
                            24</span>
                    </div>
                </div>
            </div>

            <!-- Hata Kartı -->
            <div id="errorCard"
                class="hidden animate-slide bg-red-50 dark:bg-red-950/30 rounded-2xl p-4 border border-red-100 dark:border-red-900/30">
                <div class="flex gap-3">
                    <span class="material-symbols-outlined text-red-600">report</span>
                    <div>
                        <h3 class="text-sm font-bold text-red-900 dark:text-red-400">Sonuç Alınamadı</h3>
                        <p id="errorMsg" class="text-xs text-red-700 dark:text-red-300 mt-1">Kriterlere uygun parsel
                            bulunamadı.</p>
                    </div>
                </div>
            </div>

            <!-- Nav Links -->
            <div class="pt-2 flex items-center justify-between border-t border-slate-100 dark:border-slate-800">
                <a href="index.html"
                    class="flex items-center gap-2 text-slate-500 hover:text-brand-green text-xs font-bold transition-colors">
                    <span class="material-symbols-outlined text-lg">arrow_back</span>
                    Ana Sayfa
                </a>
                <span class="text-[10px] font-bold text-slate-400">v2.2.0 - Real View</span>
            </div>
        </div>
    </aside>

    <!-- Mobile Mini Toggle (Only visible when sidebar is closed) -->
    <button id="mobileMenuBtn" onclick="toggleSidebar()"
        class="hidden absolute top-6 left-6 z-[1001] glass-panel p-3 rounded-full shadow-xl text-primary border border-white/50">
        <span class="material-symbols-outlined">menu_open</span>
    </button>

    <!-- Quick Access Menu (Sağ Orta) -->
    <div class="fixed right-4 top-1/2 -translate-y-1/2 z-[1000] flex flex-col items-end gap-3 group">
        <!-- Menu Items (Açılır Kısım) -->
        <div id="quickMenu"
            class="flex flex-col gap-3 transition-all duration-500 scale-0 opacity-0 translate-x-10 origin-right">
            <a href="index.html"
                class="flex items-center gap-3 bg-white/90 dark:bg-slate-900/90 backdrop-blur-md px-4 py-2.5 rounded-xl shadow-xl border border-white/20 hover:bg-brand-gold hover:text-white transition-all group/item">
                <span class="text-xs font-bold uppercase tracking-wider">Ana Sayfa</span>
                <div
                    class="bg-primary/10 group-hover/item:bg-white/20 p-2 rounded-lg text-primary group-hover/item:text-white transition-colors">
                    <span class="material-symbols-outlined text-xl">home</span>
                </div>
            </a>
            <a href="emlak-ilanlari.html"
                class="flex items-center gap-3 bg-white/90 dark:bg-slate-900/90 backdrop-blur-md px-4 py-2.5 rounded-xl shadow-xl border border-white/20 hover:bg-brand-gold hover:text-white transition-all group/item">
                <span class="text-xs font-bold uppercase tracking-wider">İlanlar</span>
                <div
                    class="bg-primary/10 group-hover/item:bg-white/20 p-2 rounded-lg text-primary group-hover/item:text-white transition-colors">
                    <span class="material-symbols-outlined text-xl">real_estate_agent</span>
                </div>
            </a>
            <a href="contact.html"
                class="flex items-center gap-3 bg-white/90 dark:bg-slate-900/90 backdrop-blur-md px-4 py-2.5 rounded-xl shadow-xl border border-white/20 hover:bg-brand-gold hover:text-white transition-all group/item">
                <span class="text-xs font-bold uppercase tracking-wider">İletişim</span>
                <div
                    class="bg-primary/10 group-hover/item:bg-white/20 p-2 rounded-lg text-primary group-hover/item:text-white transition-colors">
                    <span class="material-symbols-outlined text-xl">contact_support</span>
                </div>
            </a>
        </div>

        <!-- Toggle Button -->
        <button onclick="toggleQuickMenu()" id="quickMenuBtn"
            class="size-14 bg-brand-gold hover:bg-primary text-white rounded-2xl shadow-2xl flex items-center justify-center transition-all duration-300 active:scale-90 border border-white/20 relative group">
            <span class="material-symbols-outlined text-3xl transition-transform duration-500"
                id="quickMenuIcon">apps</span>
            <!-- Tooltip -->
            <span
                class="absolute right-full mr-4 px-3 py-1.5 bg-slate-900 text-white text-[10px] font-bold rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none uppercase tracking-tighter">
                Hızlı Menü
            </span>
        </button>
    </div>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // Harita Başlatma (İstanbul odaklı)
        const map = L.map('map', {
            zoomControl: false
        }).setView([41.0082, 28.9784], 10);

        // Zoom kontrolünü sağ alta alalım
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        // ESRI Satellite Tiles (Real View)
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EBP, and the GIS User Community'
        }).addTo(map);

        let currentLayer = null;

        // Mock Veriler (İstanbul Odaklı)
        const mockDistricts = {
            "İstanbul": ["Silivri", "Çatalca", "Çekmeköy"]
        };
        const mockNeighborhoods = {
            "Silivri": ["Ortaköy"],
            "Çatalca": ["Ferhatpaşa"],
            "Çekmeköy": ["Mehmet Akif"]
        };

        const citySelect = document.getElementById('citySelect');
        const districtSelect = document.getElementById('districtSelect');
        const neighborhoodSelect = document.getElementById('neighborhoodSelect');

        function initDropdowns() {
            const districts = mockDistricts["İstanbul"];
            districtSelect.innerHTML = '<option value="">Seçiniz</option>';
            districts.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d; opt.innerText = d;
                districtSelect.appendChild(opt);
            });
        }
        initDropdowns();

        districtSelect.addEventListener('change', (e) => {
            const neighborhoods = mockNeighborhoods[e.target.value] || [];
            neighborhoodSelect.innerHTML = '<option value="">Seçiniz</option>';
            neighborhoods.forEach(n => {
                const opt = document.createElement('option');
                opt.value = n; opt.innerText = n;
                neighborhoodSelect.appendChild(opt);
            });
        });

        async function sorgula() {
            const city = citySelect.value;
            const district = districtSelect.value;
            const neighborhood = neighborhoodSelect.value;
            const block = document.getElementById('blockInput').value.trim();
            const parcel = document.getElementById('parcelInput').value.trim();

            const loading = document.getElementById('loading');
            const resultCard = document.getElementById('resultCard');
            const errorCard = document.getElementById('errorCard');

            loading.classList.remove('hidden');
            resultCard.classList.add('hidden');
            errorCard.classList.add('hidden');
            if (currentLayer) map.removeLayer(currentLayer);

            try {
                const response = await fetch(`/api/parcel?city=${city}&district=${district}&neighborhood=${neighborhood}&block=${block}&parcel=${parcel}`);
                const data = await response.json();

                if (data.success) {
                    const coords = data.data.coordinates;
                    const polygon = L.polygon(coords, {
                        color: '#FFE082',
                        fillColor: '#FFE082',
                        fillOpacity: 0.4,
                        weight: 4
                    }).addTo(map);

                    currentLayer = polygon;
                    map.fitBounds(polygon.getBounds(), { padding: [100, 100], maxZoom: 18 });

                    polygon.bindPopup(`
                        <div class="px-2 py-1">
                            <h3 class="font-extrabold text-primary text-base">Ada: ${block} / Parsel: ${parcel}</h3>
                            <p class="text-[10px] text-slate-500 uppercase font-black border-t border-slate-200 mt-1 pt-1">${district} - ${neighborhood}</p>
                        </div>
                    `).openPopup();

                    document.getElementById('resLocation').innerText = `${city} / ${district}`;
                    document.getElementById('resBlockParcel').innerText = `${block} / ${parcel}`;
                    resultCard.classList.remove('hidden');

                    // Mobile-friendly: close sidebar after find
                    if (window.innerWidth < 768) toggleSidebar();

                } else {
                    document.getElementById('errorMsg').innerText = data.message || "Parsel bulunamadı.";
                    errorCard.classList.remove('hidden');
                }
            } catch (error) {
                document.getElementById('errorMsg').innerText = "Bağlantı hatası oluştu.";
                errorCard.classList.remove('hidden');
            } finally {
                loading.classList.add('hidden');
            }
        }

        // Sidebar Toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mobileBtn = document.getElementById('mobileMenuBtn');

            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full', 'opacity-0');
                if (window.innerWidth < 768) mobileBtn.classList.add('hidden');
            } else {
                sidebar.classList.add('-translate-x-full', 'opacity-0');
                if (window.innerWidth < 768) mobileBtn.classList.remove('hidden');
            }
        }
    </script>
    <!-- Shared Auth Logic -->
    <script src="assets/js/auth.js"></script>
    <script>
        // Init logic for Map page
        window.addEventListener('load', () => {
            if (window.innerWidth < 768) toggleSidebar();
        });
    </script>
</body>

</html>